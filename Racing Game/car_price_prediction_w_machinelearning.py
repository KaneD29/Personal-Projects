# -*- coding: utf-8 -*-
"""Car_Price_Prediction_w/MachineLearning

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1d6ulX3g-VjhV3L2P4mqJVBRyRipIPrcX
"""

import datetime

import numpy as np
import pandas as pd

import matplotlib.pyplot as plt
import seaborn as sns

from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.ensemble import RandomForestRegressor
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import r2_score

train = pd.read_csv("train.csv")
test = pd.read_csv("test.csv")

xtrain = train.drop("Price", axis = 1 )
ytrain = train["Price"]

xtest = test.drop("Price", axis = 1)
ytest = test["Price"]

plt.figure(figsize= (12,8))
plot = sns.countplot(x = 'Manufacturer', data = xtrain)
plt.xticks(rotation = 90)
for p in plot.patches:
    plot.annotate(
                  p.get_height(),
                  (p.get_x() + p.get_width() / 2.0,
                  p.get_height()),
                  ha = 'center',
                  va = 'center',
                  xytext = (0,5),
                  textcoords = 'offset points')

plt.title("Count of cars based on manufacturers")
plt.xlabel("Manufacturer")
plt.ylabel("Count of Cars")

xtrain.drop("Levy", axis = 1, inplace = True)
xtest.drop("Levy", axis = 1, inplace = True)

curr_time = datetime.datetime.now()
xtrain['Years_Used'] = xtrain['Prod. year'].apply(lambda x : curr_time.year - x)
xtest['Years_Used'] = xtest['Prod. year'].apply(lambda x : curr_time.year - x)

xtrain["Mileage"] = xtrain["Mileage"].str.replace(r'\D', '', regex = True).astype(int)
xtest["Mileage"] = xtest["Mileage"].str.replace(r'\D', '', regex = True).astype(int)

xtrain = xtrain.fillna(0)
xtest = xtest.fillna(0)

all_features = pd.concat([xtrain, xtest], axis=0)

all_dummies = pd.get_dummies(all_features, columns=[
    "Manufacturer", "Fuel type", "Category", "Gear box type", "Drive wheels",
    "Doors", "Wheel", "Color", "Model", "Leather interior", "Engine volume"
])

xtrain = all_dummies.iloc[:len(xtrain), :].fillna(0)
xtest = all_dummies.iloc[len(xtrain):, :].fillna(0)

_xtrain_df = all_dummies.iloc[:len(xtrain), :].fillna(0)
_xtest_df = all_dummies.iloc[len(xtrain):, :].fillna(0)


X_train_split, X_val_split, y_train_split, y_val_split = train_test_split(
    _xtrain_df, ytrain, test_size=0.2, random_state=42
)


standardScaler = StandardScaler()


X_train_scaled = standardScaler.fit_transform(X_train_split)
X_val_scaled = standardScaler.transform(X_val_split)


X_test_final_scaled = standardScaler.transform(_xtest_df)


linearRegression = LinearRegression()
linearRegression.fit(X_train_scaled, y_train_split)


y_pred_val = linearRegression.predict(X_val_scaled)


r2_val_score = r2_score(y_val_split, y_pred_val)
print(f"R2 Score on validation set: {r2_val_score}")

y_pred_final = linearRegression.predict(X_test_final_scaled)

rf = RandomForestRegressor(n_estimators = 100, random_state=42)

X_train_rf, X_val_rf, y_train_rf, y_val_rf = train_test_split(xtrain, ytrain, test_size=0.2, random_state=42)

rf.fit(X_train_rf, y_train_rf)

y_pred_rf_val = rf.predict(X_val_rf)
r2_val_score_rf = r2_score(y_val_rf, y_pred_rf_val)
print(f"R2 Score on validation set (RandomForest): {r2_val_score_rf}")

y_pred = rf.predict(xtest)